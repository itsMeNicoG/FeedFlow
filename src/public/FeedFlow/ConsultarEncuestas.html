<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FeedFlow-Consulta encuestas</title>
    <link rel="stylesheet" href="CSS/Normalize.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair:ital,opsz,wght@0,5..1200,300..900;1,5..1200,300..900&family=Raleway:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="CSS/app.css">
    <script src="JS/auth.js"></script>
    <script src="JS/navigation.js"></script>

</head>

<body>
    <header class="inicio">
        <img class="logo" src="IMG/Logo.png">
        <h1 class="nombre-sitio"> Feed <span> Flow </span> </h1>
        <button onclick="cerrarSesion()" style="position: absolute; right: 20px; top: 20px; padding: 10px 20px; background-color: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Cerrar Sesión</button>
    </header>

    <div class="contenedor-navegacion">
      <nav class="nav-principal  contenedor">
        <li><a class="enlacenav" href="MenuPrincipal.html">Inicio</a> </li>
        <li id="menu-usuarios" style="display: none;"> <a href="#">Gestión de usuarios</a>  
        <ul>
            <li> <a href="CrearUsuarios.html">Crear usuarios</a>
            <li> <a href="Consultarusuarios.html">Consultar, editar y eliminar</a>
        </ul>       
        </li>
         <li id="menu-encuestas" style="display: none;"> <a href="#">Gestión encuestas</a>  
        <ul>
            <li> <a href="CrearEncuestas.html">Crear encuestas</a>
            <li> <a href="ConsultarEncuestas.html">Consultar, editar y eliminar encuestas</a>
        </ul>       
        </li>
         <li id="menu-reportes" style="display: none;"> <a href="Reportes.html">Reportes</a></li>
        
</nav>

    </div>
       
    <main class="contenido-principal contenedor">
           <h2>Consulta de Encuestas</h2>
    <div class="campo">
             <table id="tablaEncuestas">
              <thead>
                <tr>
                  <th>Título</th>
                  <th>Descripción</th>
                  <th>Fecha de creación</th>
                  <th>Usuario de creación</th>
                  <th>Enlace</th>
                </tr>
              </thead>
              <tbody>
                <!-- Las encuestas se cargarán aquí dinámicamente -->
              </tbody>
            </table>
     </div>
    </main>


    <footer>

        </div>
        <p class="copyright"> Todos los derechos reservados.</p>

    </footer>

  <script>

        document.addEventListener('DOMContentLoaded', function () {
            // Verificar autenticación
            if (!verificarAutenticacion()) return;
            if (!verificarAccesoRol(['admin', 'creator'])) return;

            mostrarMenuSegunRol();

            // Cargar encuestas automáticamente
            cargarEncuestas();
        });

        function cargarEncuestas() {
            const token = obtenerToken();
            const tbody = document.querySelector("#tablaEncuestas tbody");
            
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Cargando encuestas...</td></tr>';

            fetch('http://localhost:3000/surveys', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => {
                        throw new Error(error.message || 'Error al cargar encuestas');
                    });
                }
                return response.json();
            })
            .then(data => {
                tbody.innerHTML = ''; // Limpiar tabla

                if (data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay encuestas creadas</td></tr>';
                    return;
                }

                data.data.forEach(survey => {
                    const row = document.createElement('tr');
                    
                    // Formatear fecha
                    const fecha = new Date(survey.created_at);
                    const fechaFormateada = fecha.toLocaleDateString('es-CO');

                    // Generar enlace de la encuesta usando el slug
                    const enlaceEncuesta = `${window.location.origin}/public/FeedFlow/ResponderEncuesta.html?slug=${survey.link_slug}`;

                    row.innerHTML = `
                        <td>${survey.title}</td>
                        <td>${survey.description}</td>
                        <td>${fechaFormateada}</td>
                        <td>${survey.creator_name || 'N/A'}</td>
                        <td>
                            <div>
                                <input class="btn" type="button" value="Copiar enlace" onclick="copiarEnlace('${enlaceEncuesta}')">
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">Error: ${error.message}</td></tr>`;
                console.error('Error:', error);
            });
        }

        function copiarEnlace(enlace) {
            navigator.clipboard.writeText(enlace)
                .then(() => {
                    alert('Enlace copiado al portapapeles: ' + enlace);
                })
                .catch(err => {
                    alert('Error al copiar el enlace: ' + err);
                    console.error('Error:', err);
                });
        }
    </script>

</body>

</html>