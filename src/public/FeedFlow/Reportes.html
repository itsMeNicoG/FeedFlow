<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FeedFlow-Reportes</title>
    <link rel="stylesheet" href="CSS/Normalize.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair:ital,opsz,wght@0,5..1200,300..900;1,5..1200,300..900&family=Raleway:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="CSS/app.css">
    <script src="JS/auth.js"></script>
    <script src="JS/navigation.js"></script>
</head>

<body>
    <header class="inicio">
        <img class="logo" src="IMG/Logo.png">
        <h1 class="nombre-sitio"> Feed <span> Flow </span> </h1>
        <button onclick="cerrarSesion()" style="position: absolute; right: 20px; top: 20px; padding: 10px 20px; background-color: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Cerrar Sesión</button>
    </header>

    <div class="contenedor-navegacion">
      <nav class="nav-principal  contenedor">
        <li><a class="enlacenav" href="MenuPrincipal.html">Inicio</a> </li>
        <li id="menu-usuarios" style="display: none;"> <a href="#">Gestión de usuarios</a>  
        <ul>
            <li> <a href="CrearUsuarios.html">Crear usuarios</a>
            <li> <a href="Consultarusuarios.html">Consultar, editar y eliminar</a>
        </ul>       
        </li>
         <li id="menu-encuestas" style="display: none;"> <a href="#">Gestión encuestas</a>  
        <ul>
            <li> <a href="CrearEncuestas.html">Crear encuestas</a>
            <li> <a href="ConsultarEncuestas.html">Consultar, editar y eliminar encuestas</a>
        </ul>       
        </li>
         <li id="menu-reportes" style="display: none;"> <a href="Reportes.html">Reportes</a></li>
        
</nav>

    <main class="contenido-principal contenedor">
        <h2>Reportes de Encuestas</h2>

        <table class="tabla-datos">
            <thead>
                <tr>
                    <th>Título</th>
                    <th>Descripción</th>
                    <th>Total Respuestas</th>
                    <th>Fecha Creación</th>
                </tr>
            </thead>
            <tbody id="tablaEncuestas">
                <tr>
                    <td colspan="4" style="text-align: center;">Cargando encuestas...</td>
                </tr>
            </tbody>
        </table>
    </main>

    <footer>
        <p class="copyright"> Todos los derechos reservados.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Verificar autenticación
            if (!verificarAutenticacion()) return;
            // Solo admin y analyst pueden ver reportes
            if (!verificarAccesoRol(['admin', 'analyst'])) return;

            mostrarMenuSegunRol();

            // Cargar lista de encuestas
            cargarListaEncuestas();
        });

        function cargarListaEncuestas() {
            const token = obtenerToken();
            const tbody = document.getElementById('tablaEncuestas');

            fetch('http://localhost:3000/surveys', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => {
                        throw new Error(error.message || 'Error al cargar encuestas');
                    });
                }
                return response.json();
            })
            .then(data => {
                tbody.innerHTML = '';

                if (data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No hay encuestas disponibles</td></tr>';
                    return;
                }

                data.data.forEach(survey => {
                    // Obtener conteo de respuestas para cada encuesta
                    fetch(`http://localhost:3000/reports/${survey.id}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => response.json())
                    .then(reportData => {
                        const row = document.createElement('tr');
                        row.style.cursor = 'pointer';
                        row.addEventListener('click', () => {
                            window.location.href = `DetalleReporte.html?id=${survey.id}`;
                        });

                        const fecha = new Date(survey.created_at);
                        const fechaFormateada = fecha.toLocaleDateString('es-CO');
                        const totalRespuestas = reportData.survey ? reportData.survey.total_responses : 0;

                        row.innerHTML = `
                            <td>${survey.title}</td>
                            <td>${survey.description || 'Sin descripción'}</td>
                            <td style="text-align: center;">${totalRespuestas}</td>
                            <td>${fechaFormateada}</td>
                        `;

                        tbody.appendChild(row);
                    })
                    .catch(error => {
                        const row = document.createElement('tr');
                        row.style.cursor = 'pointer';
                        row.addEventListener('click', () => {
                            window.location.href = `DetalleReporte.html?id=${survey.id}`;
                        });

                        const fecha = new Date(survey.created_at);
                        const fechaFormateada = fecha.toLocaleDateString('es-CO');

                        row.innerHTML = `
                            <td>${survey.title}</td>
                            <td>${survey.description || 'Sin descripción'}</td>
                            <td style="text-align: center;">-</td>
                            <td>${fechaFormateada}</td>
                        `;

                        tbody.appendChild(row);
                    });
                });
            })
            .catch(error => {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">Error: ${error.message}</td></tr>`;
                console.error('Error:', error);
            });
        }
    </script>

</body>

</html>